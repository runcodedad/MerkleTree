name: Performance Benchmarks (Example)

# This is an EXAMPLE workflow for running performance benchmarks
# To use it:
# 1. Copy this file to .github/workflows/benchmarks.yml
# 2. Adjust the configuration as needed for your repository
# 3. Commit and push to enable benchmark automation

on:
  # Run on pull requests to main
  pull_request:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'benchmarks/**'
      - '.github/workflows/benchmarks.yml'
  
  # Run on pushes to main (after merge)
  push:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'benchmarks/**'
  
  # Allow manual triggering
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  benchmarks:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'
        
    - name: Restore dependencies
      run: dotnet restore
      
    - name: Build
      run: dotnet build --no-restore --configuration Release
      
    - name: Run Fast Benchmarks (PR)
      if: github.event_name == 'pull_request'
      run: |
        cd benchmarks/MerkleTree.Benchmarks
        dotnet run -c Release -- --filter *Small* --exporters json markdown
      
    - name: Run All Benchmarks (Push to main)
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        cd benchmarks/MerkleTree.Benchmarks
        dotnet run -c Release -- --exporters json markdown html
      
    - name: Upload Benchmark Results
      uses: actions/upload-artifact@v4
      with:
        name: benchmark-results-${{ github.sha }}
        path: benchmarks/MerkleTree.Benchmarks/BenchmarkDotNet.Artifacts/results/
        retention-days: 90
    
    - name: Find Markdown Report
      id: find-report
      run: |
        cd benchmarks/MerkleTree.Benchmarks/BenchmarkDotNet.Artifacts/results
        REPORT_FILE=$(ls *-report.md | head -1)
        echo "report=$REPORT_FILE" >> $GITHUB_OUTPUT
        
    - name: Comment PR with Benchmark Results
      if: github.event_name == 'pull_request'
      uses: marocchino/sticky-pull-request-comment@v2
      with:
        recreate: true
        header: benchmark-results
        path: benchmarks/MerkleTree.Benchmarks/BenchmarkDotNet.Artifacts/results/${{ steps.find-report.outputs.report }}
